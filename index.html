<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Note Guessing — Eb Sax Mode</title>
<style>
  :root{ --bg:#0f1724; --card:#0b1220; --accent:#ffb86b; --muted:#98a0b3; --good:#6ee7b7; --bad:#ff7b7b; font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;}
  body{background:linear-gradient(180deg,#071022 0%, #071a2e 100%); color:#e6eef8; margin:0; padding:24px; display:flex; align-items:flex-start; justify-content:center; min-height:100vh;}
  .wrap{width:980px; max-width:96%; background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.02)); border-radius:12px; padding:20px; box-shadow:0 8px 30px rgba(2,6,23,0.6);}
  header{display:flex; gap:16px; align-items:center; margin-bottom:12px;}
  h1{font-size:20px; margin:0;}
  .controls{display:flex; gap:12px; flex-wrap:wrap; align-items:center; margin-bottom:14px;}
  label{font-size:13px; color:var(--muted);}
  select, input[type=range], button{background:#071226; color:inherit; border:1px solid rgba(255,255,255,0.04); padding:8px 10px; border-radius:8px;}
  .panel{display:flex; gap:16px;}
  .left{flex:1; min-width:300px;}
  .right{width:320px;}
  .card{background:var(--card); padding:16px; border-radius:10px; margin-bottom:12px;}
  .big-note{font-size:44px; font-weight:700; margin:8px 0; letter-spacing:0.02em;}
  .buttons{display:flex; gap:8px; margin-top:10px; flex-wrap:wrap;}
  .choice{flex:1; min-width:86px; padding:10px; background:transparent; border:1px solid rgba(255,255,255,0.04); border-radius:8px; text-align:center; cursor:pointer;}
  .choice.correct{background:linear-gradient(90deg,#003d2f,#075b46); color:var(--good); border-color:rgba(110,231,183,0.12);}
  .choice.wrong{background:linear-gradient(90deg,#3b0f0f,#591010); color:var(--bad); border-color:rgba(255,123,123,0.12);}
  .muted{color:var(--muted); font-size:13px;}
  footer{font-size:13px; color:var(--muted); margin-top:8px;}
  .small{font-size:13px;}
  .score{font-weight:700;}
  .hint{font-size:13px; color:var(--muted); margin-top:6px;}
  .playbtn{background:linear-gradient(90deg,var(--accent), #ff9a6b); color:#06121a; border:none; padding:10px 14px; border-radius:10px; font-weight:700; cursor:pointer;}
  .row{display:flex; gap:8px; align-items:center;}
  .kbd{background:#071226;border-radius:6px;padding:6px 8px;font-size:13px;}
</style>
</head>
<body>
  <div class="wrap" role="application" aria-label="Note guessing app">
    <header>
      <h1>Note Guessing — Eb Sax Mode</h1>
      <div class="muted small">Synth sax timbre • WebAudio • Offline</div>
    </header>

    <div class="controls card">
      <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;">
        <label>Mode:
          <select id="mode">
            <option value="concert">Concert pitch (display = heard)</option>
            <option value="eb">Eb transposed (display = written for Eb sax)</option>
          </select>
        </label>

        <label>Range:
          <select id="range">
            <option value="C3-C5">C3 — C5</option>
            <option value="C4-C6">C4 — C6</option>
            <option value="A2-A4">A2 — A4</option>
          </select>
        </label>

        <label>Choices:
          <select id="choices">
            <option value="4">4</option>
            <option value="8" selected>8</option>
            <option value="12">12</option>
          </select>
        </label>

        <label>Volume:
          <input id="volume" type="range" min="0" max="1" step="0.01" value="0.6" />
        </label>

        <button id="play" class="playbtn">Play Note ▶</button>
        <button id="next">Next</button>
      </div>

      <div style="margin-top:10px" class="muted small">Tip: press <span class="kbd">Space</span> to play the note. Select a mode: <strong>Eb</strong> shows the written note an Eb alto sax player would finger while playing the sounding pitch.</div>
    </div>

    <div class="panel">
      <div class="left">
        <div class="card">
          <div class="muted small">Identify this note</div>
          <div id="displayNote" class="big-note">—</div>
          <div id="info" class="muted small">Press Play to hear the note.</div>

          <div class="buttons" id="choicesArea" style="margin-top:12px;">
            <!-- choices inserted here -->
          </div>

          <div class="hint" id="hintArea"></div>
        </div>

        <div class="card">
          <div class="row"><div class="muted">Score:</div><div style="flex:1"></div><div class="score" id="score">0 / 0</div></div>
          <div class="muted small" style="margin-top:8px" id="streak">Streak: 0</div>
        </div>
      </div>

      <aside class="right">
        <div class="card">
          <div class="muted small">Settings</div>
          <div style="margin-top:8px">
            <label><input id="saxLike" type="checkbox" checked /> Use sax-like timbre</label>
            <div class="muted small" style="margin-top:8px">Synthesis uses two oscillators, noise + filter, and an ADSR to get a warm woodwind sound.</div>
          </div>
        </div>

        <div class="card">
          <div class="muted small">Transposition help</div>
          <div style="margin-top:8px" id="transposeHelp">
            In <strong>Eb</strong> mode the app shows the <em>written</em> note for an E♭ alto saxophonist and plays the actual sounding pitch (written − 9 semitones).
          </div>
        </div>

        <div class="card">
          <div class="muted small">Keyboard shortcuts</div>
          <ul class="muted small">
            <li><strong>Space</strong> — Play note</li>
            <li><strong>1…9</strong> — Choose answer (if visible)</li>
            <li><strong>N</strong> — Next</li>
          </ul>
        </div>
      </aside>
    </div>

    <footer class="muted small">Made for practicing transposed notes for Eb sax. If you want real recorded sax samples instead of synthesis I can adapt the UI to accept uploaded samples.</footer>
  </div>

<script>
/* --- Utility: note <-> frequency --- 
   A4 = 440Hz. Note indices: C0 = MIDI 12. We'll compute frequency from MIDI number.
*/
const A4_MIDI = 69;
const A4_FREQ = 440.0;

function midiToFreq(m) {
  return A4_FREQ * Math.pow(2, (m - A4_MIDI)/12);
}
const NOTE_NAMES = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
function midiToName(m) {
  const n = m % 12;
  const oct = Math.floor(m/12) - 1;
  return NOTE_NAMES[n] + oct;
}
// parse range like C3-C5
function parseRange(r) {
  function nameToMidi(name) {
    // e.g. C4, A#3
    const match = name.match(/^([A-G]#?)(-?\d+)$/i);
    if(!match) return null;
    const pitch = match[1].toUpperCase();
    const octave = parseInt(match[2],10);
    const index = NOTE_NAMES.indexOf(pitch);
    if(index < 0) return null;
    return (octave + 1) * 12 + index; // C0 = midi 12
  }
  const [s,e] = r.split('-');
  return [nameToMidi(s), nameToMidi(e)];
}

/* --- UI references --- */
const playBtn = document.getElementById('play');
const nextBtn = document.getElementById('next');
const displayNote = document.getElementById('displayNote');
const info = document.getElementById('info');
const choicesArea = document.getElementById('choicesArea');
const modeSel = document.getElementById('mode');
const rangeSel = document.getElementById('range');
const choicesSel = document.getElementById('choices');
const volumeEl = document.getElementById('volume');
const saxLikeChk = document.getElementById('saxLike');
const scoreEl = document.getElementById('score');
const streakEl = document.getElementById('streak');
const hintArea = document.getElementById('hintArea');

let audioCtx = null;
let masterGain = null;

/* --- State --- */
let current = { writtenMidi: null, soundingMidi: null };
let total = 0, correct = 0, streak = 0;

/* --- Transposition constants --- */
/* Alto sax in E♭: sounding = written - 9 semitones (a major sixth down). 
   That means to show the written note for sax and play the sounding pitch we compute:
     writtenMidi = targetWritten
     soundingMidi = writtenMidi - 9
*/
const EB_ALTO_SHIFT = -9; // semitone shift from written -> sounding

/* --- Generate random note within range --- */
function randomNoteInRange(rangeStr) {
  const [low,high] = parseRange(rangeStr);
  const midi = Math.floor(Math.random() * (high - low + 1)) + low;
  return midi;
}

/* --- Build choices; returns array of midi numbers for displayed names (written) --- */
function buildChoices(writtenMidi, count) {
  // We'll include the correct writtenMidi plus other random notes near it
  const [low,high] = parseRange(rangeSel.value);
  const set = new Set([writtenMidi]);
  const spread = Math.max(6, Math.floor((high-low)/8));
  while(set.size < count) {
    const offset = (Math.floor(Math.random()* (spread*2+1)) - spread);
    const candidate = writtenMidi + offset;
    if(candidate >= low && candidate <= high) set.add(candidate);
  }
  // shuffle
  const arr = Array.from(set);
  for(let i=arr.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]] = [arr[j],arr[i]];
  }
  return arr;
}

/* --- UI update for a new question --- */
function newQuestion() {
  // create or resume audio context lazily on user gesture
  if(!audioCtx) createAudio();

  hintArea.textContent = '';
  const mode = modeSel.value;
  // choose a "written" midi depending on mode:
  // - Concert: we'll pick a sounding midi (what we play and display are same)
  // - Eb: pick a written midi (what we display) then compute sounding = written + shift
  let writtenMidi, soundingMidi;
  if(mode === 'concert') {
    soundingMidi = randomNoteInRange(rangeSel.value);
    writtenMidi = soundingMidi; // display = heard
  } else if(mode === 'eb') {
    writtenMidi = randomNoteInRange(rangeSel.value);
    soundingMidi = writtenMidi + EB_ALTO_SHIFT; // sounding lower
  } else {
    soundingMidi = randomNoteInRange(rangeSel.value);
    writtenMidi = soundingMidi;
  }

  current.writtenMidi = writtenMidi;
  current.soundingMidi = soundingMidi;

  displayNote.textContent = midiToName(writtenMidi);
  info.textContent = 'Press Play to hear it (or Space).';
  renderChoices();
}

/* --- Render choice buttons --- */
function renderChoices() {
  choicesArea.innerHTML = '';
  const count = parseInt(choicesSel.value,10);
  const choices = buildChoices(current.writtenMidi, count);
  choices.forEach((wmidi, idx) => {
    const btn = document.createElement('button');
    btn.className = 'choice';
    btn.textContent = midiToName(wmidi);
    btn.dataset.written = wmidi;
    btn.addEventListener('click', onChoose);
    choicesArea.appendChild(btn);
  });
}

/* --- Handle user answer --- */
function onChoose(e) {
  const chosen = parseInt(e.currentTarget.dataset.written,10);
  const correctWritten = current.writtenMidi;
  total++;
  if(chosen === correctWritten) {
    correct++;
    streak++;
    e.currentTarget.classList.add('correct');
    hintArea.textContent = 'Correct! Played = ' + midiToName(current.soundingMidi);
  } else {
    streak = 0;
    e.currentTarget.classList.add('wrong');
    // reveal correct choice button
    Array.from(choicesArea.children).forEach(b=>{
      if(parseInt(b.dataset.written,10) === correctWritten) b.classList.add('correct');
    });
    hintArea.textContent = `Incorrect. Played = ${midiToName(current.soundingMidi)} (displayed/written: ${midiToName(correctWritten)})`;
  }
  updateScore();
  // disable choices
  Array.from(choicesArea.children).forEach(b=>b.disabled = true);
}

/* --- Score UI --- */
function updateScore() {
  scoreEl.textContent = `${correct} / ${total}`;
  streakEl.textContent = `Streak: ${streak}`;
}

/* --- Audio: create context and helper to play note --- */
function createAudio() {
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  masterGain = audioCtx.createGain();
  masterGain.gain.value = parseFloat(volumeEl.value);
  masterGain.connect(audioCtx.destination);
}

/* Sax-like synth: two detuned saws, noise + bandpass, simple ADSR, small vibrato */
function playSynthFrequency(freq, timeSec = 0) {
  if(!audioCtx) createAudio();
  const t0 = audioCtx.currentTime + 0.02;
  const dur = 2.0;

  // Gain envelope
  const g = audioCtx.createGain();
  g.gain.setValueAtTime(0.0001, t0);
  g.gain.linearRampToValueAtTime(1.0, t0 + 0.02);
  g.gain.exponentialRampToValueAtTime(0.12, t0 + 0.6);
  g.gain.exponentialRampToValueAtTime(0.0001, t0 + dur);
  g.connect(masterGain);

  // Two saw oscillators (approx warm woodwind)
  const osc1 = audioCtx.createOscillator();
  osc1.type = 'sawtooth';
  osc1.frequency.value = freq;
  const osc2 = audioCtx.createOscillator();
  osc2.type = 'sawtooth';
  osc2.frequency.value = freq * 1.005; // slight detune

  // subtle vibrato LFO
  const lfo = audioCtx.createOscillator();
  lfo.frequency.value = 5.5; // Hz
  const lfoGain = audioCtx.createGain();
  lfoGain.gain.value = freq * 0.0018; // tiny freq modulation
  lfo.connect(lfoGain);
  lfoGain.connect(osc1.frequency);
  lfoGain.connect(osc2.frequency);

  // Merge oscs
  const oscGain = audioCtx.createGain();
  oscGain.gain.value = 0.9;
  osc1.connect(oscGain);
  osc2.connect(oscGain);

  // Brightness contour via filter
  const bp = audioCtx.createBiquadFilter();
  bp.type = 'bandpass';
  bp.frequency.value = Math.max(400, freq * 2.3);
  bp.Q.value = 1.6;
  oscGain.connect(bp);

  // Add noise for reed-ish texture when saxLike is on
  let noiseNode;
  if(saxLikeChk.checked) {
    const bufferSize = 2 * audioCtx.sampleRate;
    const noiseBuffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
    const data = noiseBuffer.getChannelData(0);
    for(let i=0;i<bufferSize;i++) data[i] = (Math.random()*2 -1) * 0.35;
    noiseNode = audioCtx.createBufferSource();
    noiseNode.buffer = noiseBuffer;
    const noiseFilter = audioCtx.createBiquadFilter();
    noiseFilter.type = 'lowpass';
    noiseFilter.frequency.value = Math.max(1200, freq * 3.0);
    noiseNode.connect(noiseFilter);
    // scale noise by envelope
    const noiseGain = audioCtx.createGain();
    noiseGain.gain.setValueAtTime(0.12, t0);
    noiseFilter.connect(noiseGain);
    noiseGain.connect(g);
    // also mix filtered osc into envelope gain
    bp.connect(g);
    noiseNode.start(t0);
    noiseNode.stop(t0 + dur + 0.1);
  } else {
    bp.connect(g);
  }

  osc1.start(t0);
  osc2.start(t0);
  lfo.start(t0);

  // stop nodes
  osc1.stop(t0 + dur + 0.02);
  osc2.stop(t0 + dur + 0.02);
  lfo.stop(t0 + dur + 0.02);
}

/* --- Play current note (use soundingMidi) --- */
function playCurrent() {
  if(!current.soundingMidi) return;
  if(!audioCtx) createAudio();
  // resume if suspended (user gesture may be required)
  if(audioCtx.state === 'suspended') {
    audioCtx.resume();
  }
  masterGain.gain.value = parseFloat(volumeEl.value);
  const freq = midiToFreq(current.soundingMidi);
  playSynthFrequency(freq);
}

/* --- Event wiring --- */
playBtn.addEventListener('click', ()=> {
  playCurrent();
});
nextBtn.addEventListener('click', ()=> {
  newQuestion();
  // enable choices
  Array.from(choicesArea.children).forEach(b=>{ b.disabled = false; b.className = 'choice'; });
});
document.addEventListener('keydown', (ev) => {
  if(ev.code === 'Space') {
    ev.preventDefault();
    playCurrent();
  } else if(ev.key.toLowerCase() === 'n') {
    newQuestion();
  } else {
    // numeric shortcuts 1..9
    const k = parseInt(ev.key,10);
    if(!isNaN(k) && k >=1) {
      const idx = k - 1;
      const btn = choicesArea.children[idx];
      if(btn && !btn.disabled) btn.click();
    }
  }
});

/* --- Initialize --- */
newQuestion();
updateScore();

/* accessibility: update displayNote aria label on mode change */
modeSel.addEventListener('change', () => {
  if(modeSel.value === 'eb') {
    document.getElementById('transposeHelp').textContent = 'In Eb mode the app shows the written note for an E♭ alto saxophonist and plays the actual sounding pitch (written − 9 semitones).';
  } else {
    document.getElementById('transposeHelp').textContent = 'Concert mode: the displayed name is the same as the sounded pitch.';
  }
  newQuestion();
});
rangeSel.addEventListener('change', newQuestion);
choicesSel.addEventListener('change', newQuestion);
volumeEl.addEventListener('input', ()=> {
  if(masterGain) masterGain.gain.value = parseFloat(volumeEl.value);
});
saxLikeChk.addEventListener('change', ()=> {
  // nothing immediate
});
</script>
</body>
</html>
